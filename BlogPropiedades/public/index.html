<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Goza Madrid - Portal inmobiliario y blog de propiedades" />
    <title>GozaMadrid - Inmobiliaria y Blog</title>
    
    <!-- Bootstrap debe cargarse antes que nada para configurar el entorno -->
    <script src="/bootstrap.js"></script>
    
    <!-- Script de recuperación de emergencia para errores de inicialización -->
    <script>
      (function() {
        // Registrar el tiempo de carga inicial
        window.__loadStartTime = Date.now();
        
        // Sistema de recuperación para errores de inicialización
        window.addEventListener('error', function(e) {
          if (e && e.message && 
             (e.message.includes("Cannot access") || 
              e.message.includes("before initialization") ||
              e.message.includes("is not defined") ||
              e.message.includes("Nc"))) {
            
            console.error("🚨 Detectado error crítico de inicialización:", e.message);
            
            // Verificar si ya intentamos recargar antes
            var reloadCount = parseInt(localStorage.getItem('app_reload_count') || '0');
            var lastReload = localStorage.getItem('app_last_reload');
            var now = new Date().toISOString();
            
            // Si hemos recargado demasiado en poco tiempo, mostrar mensaje de error
            if (reloadCount > 3 && lastReload) {
              var lastTime = new Date(lastReload).getTime();
              var timeDiff = Date.now() - lastTime;
              
              // Si han pasado menos de 10 segundos desde la última recarga
              if (timeDiff < 10000) {
                // Mostrar mensaje de error en vez de recargar
                document.body.innerHTML = `
                  <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background-color: #f9fafb; font-family: sans-serif;">
                    <div style="max-width: 500px; background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                      <h2 style="color: #dc2626; margin-top: 0;">Se detectaron problemas al cargar la aplicación</h2>
                      <p>Estamos experimentando dificultades técnicas. Por favor, intente una de estas opciones:</p>
                      <ol style="margin-bottom: 20px;">
                        <li>Limpiar la caché del navegador</li>
                        <li>Usar el modo incógnito</li>
                        <li>Intentar con otro navegador</li>
                      </ol>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="localStorage.clear(); window.location.reload();" 
                                style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                          Limpiar datos y reintentar
                        </button>
                        <button onclick="window.location.reload();" 
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                          Recargar simplemente
                        </button>
                      </div>
                    </div>
                  </div>
                `;
                return;
              }
            }
            
            // Incrementar contador y guardar timestamp
            localStorage.setItem('app_reload_count', reloadCount + 1);
            localStorage.setItem('app_last_reload', now);
            localStorage.setItem('app_last_error', e.message);
            
            // Limpiar solo ciertos datos que podrían causar problemas
            // pero mantener la sesión del usuario si es posible
            var keysToPreserve = ['token', 'name', 'email', 'profilePic'];
            var preserved = {};
            
            // Guardar datos importantes
            try {
              keysToPreserve.forEach(function(key) {
                var value = localStorage.getItem(key);
                if (value) preserved[key] = value;
              });
            } catch (err) {}
            
            // Limpiar datos problemáticos específicos
            try {
              var problemKeys = [
                'lastRenderCycle', 
                'errorsHistory', 
                'app_errors', 
                'env_validation',
                'recentErrors_api_401_error',
                'recentErrors_auth_401',
                'recentErrors_server_500'
              ];
              
              problemKeys.forEach(function(key) {
                localStorage.removeItem(key);
              });
            } catch (err) {}
            
            // Si hay demasiadas recargas, hacer limpieza profunda
            if (reloadCount >= 3) {
              try {
                // Limpiar todo excepto token
                var token = localStorage.getItem('token');
                localStorage.clear();
                if (token) localStorage.setItem('token', token);
              } catch (err) {}
            }
            
            // Recargar la página después de un breve retraso
            setTimeout(function() {
              window.location.reload();
            }, 1000);
          }
        });
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html> 